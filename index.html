<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Responsive Image Carousel</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">

  <!-- Preload -->
  <link rel="preload" as="image" href="images/1.jpg">
  <link rel="preload" as="image" href="images/2.jpg">
  <link rel="preload" as="image" href="images/3.jpg">
  <link rel="preload" as="image" href="arrows/backward-arrow.png">
  <link rel="preload" as="image" href="arrows/forward-arrow.png">

  <style>
    :root { --row-gap: clamp(4px, 0.75vw, 12px); --arrow-size: clamp(3rem, 8vw, 5rem); }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; min-width: 0; min-height: 0; }
    body { font-family: 'Ubuntu', sans-serif; background: #fff; height: 100vh; overflow: hidden; }

    .container { position: relative; height: 100vh; width: 100vw; min-width: 0; min-height: 0; }
    #imageContainer { height: 100%; width: 100%; min-width: 0; min-height: 0; }

    .desktop-wrapper { height: 100%; flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; min-width: 0; min-height: 0; }

    .scroller {
      display: flex; flex-direction: column; gap: var(--row-gap);
      overflow-x: auto; overflow-y: hidden; scroll-behavior: smooth;
      height: 100%; flex: 1; min-width: 0; min-height: 0;
    }

    .image-row {
      display: flex; flex-direction: row; flex: 0 0 auto; gap: var(--row-gap);
      height: calc((100% - var(--row-gap)) / 2);
      overflow: hidden; min-width: 0; min-height: 0;
    }

    .image-box {
      position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
      flex: 0 0 auto; height: 100%; background: transparent;   /* no white bars */
      min-width: 0; min-height: 0;
    }
    .image-box.clickable { cursor: pointer; }

    .image-box img {
      display: block;
      width: 100%; height: 100%;
      object-fit: cover;             /* fill container, crop if needed */
      object-position: center center;
      opacity: 0; transition: opacity 200ms ease;
    }
    .image-box.loaded img { opacity: 0.9; }
    .image-box.clickable:hover img { opacity: 0.75; }

    .image-title {
      position: absolute; bottom: 10px; left: 10px; z-index: 4; color: #000;
      font-size: clamp(0.66rem, 1.7vw, 1.33rem); font-weight: bold;
      text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
      pointer-events: none;
    }

    .skeleton { background: #f3f3f3; position: relative; }
    .skeleton::after {
      content: ""; position: absolute; inset: 0;
      background: linear-gradient(90deg, transparent, rgba(0,0,0,0.04), transparent);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    .arrow { position: absolute; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 0; z-index: 10; transition: transform 0.1s ease; user-select: none; -webkit-tap-highlight-color: transparent; }
    .arrow:active { transform: translateY(-50%) scale(0.9); }
    .arrow.left { left: 0.75rem; } .arrow.right { right: 0.75rem; }
    .arrow img { width: var(--arrow-size); height: auto; display: block; }

    @media (min-width: 764px) {
      .image-box { width: min(66vh, 60vw); }
      .image-row { align-items: stretch; }
    }

    @media (max-width: 763px) {
      #imageContainer {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap;
        overflow-x: auto; overflow-y: hidden;
        height: 100vh; gap: var(--row-gap); align-items: center;
        scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
      }
      .image-box {
        flex: 0 0 100vw;
        width: 100vw;
        height: 100vh;
        scroll-snap-align: start;
      }
      .image-title { font-size: clamp(0.53rem, 2.6vw, 0.8rem); }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="arrow left" id="arrowLeft" aria-label="Previous">
      <img id="arrowLeftImg" alt="Previous" />
    </button>
    <div id="imageContainer"></div>
    <button class="arrow right" id="arrowRight" aria-label="Next">
      <img id="arrowRightImg" alt="Next" />
    </button>
  </div>

  <script>
    const VERSION = 'v2025-09-16-3';
    function asset(path) {
      const here = document.currentScript?.src ? new URL('.', document.currentScript.src) : new URL('.', location.href);
      const url = new URL(path, here);
      url.searchParams.set('v', VERSION);
      return url.href;
    }

    document.getElementById('arrowLeftImg').src = asset('arrows/backward-arrow.png');
    document.getElementById('arrowRightImg').src = asset('arrows/forward-arrow.png');

    let _lastIsMobile = null;
    let _resizeTimer = null;

    function attachLazy(imgEl, index, priority=false) {
      const primary = asset(`images/${index}.jpg`);
      const fallback = asset(`images/${index}.png`);
      const loadSrc = (src) => { imgEl.src = src; if (priority) imgEl.fetchPriority = 'high'; };
      let triedPng = false;
      imgEl.addEventListener('error', () => { if (!triedPng) { triedPng = true; loadSrc(fallback); } }, { once: true });
      imgEl.addEventListener('load', () => { imgEl.closest('.image-box')?.classList.add('loaded'); }, { once: true });
      imgEl.dataset.primary = primary; imgEl.dataset.fallback = fallback;
    }

    const io = new IntersectionObserver((entries) => {
      for (const e of entries) {
        if (e.isIntersecting) {
          const img = e.target;
          if (!img.src) img.src = img.dataset.primary;
          io.unobserve(img);
        }
      }
    }, { root: null, rootMargin: '800px 100px', threshold: 0.01 });

    function safeNavigate(link) {
      if (!link) return;
      try { window.open(link, '_top'); return; } catch {}
      try { window.open(link, '_blank', 'noopener'); return; } catch {}
      location.href = link;
    }

    function createImageBox(index, title, link, hideCaption, priority=false) {
      const box = document.createElement('div');
      box.className = 'image-box skeleton';
      if (link && link.trim()) {
        box.classList.add('clickable');
        box.addEventListener('click', () => safeNavigate(link), { passive: true });
      }
      const img = document.createElement('img');
      img.alt = title || ''; img.loading = 'lazy'; img.decoding = 'async';
      attachLazy(img, index, priority); io.observe(img);
      img.addEventListener('load', () => { box.classList.remove('skeleton'); }, { once: true });
      box.appendChild(img);
      if (!hideCaption && (title && title.length)) {
        const caption = document.createElement('div');
        caption.className = 'image-title'; caption.textContent = title;
        box.appendChild(caption);
      }
      return box;
    }

    function setupArrowVisibility(scroller) {
      const left = document.getElementById('arrowLeft');
      const right = document.getElementById('arrowRight');
      if (!scroller) { left.style.display = 'none'; right.style.display = 'none'; return; }
      const maxScrollLeft = scroller.scrollWidth - scroller.clientWidth;
      left.style.display = scroller.scrollLeft > 10 ? 'block' : 'none';
      right.style.display = scroller.scrollLeft < Math.max(0, maxScrollLeft - 10) ? 'block' : 'none';
    }

    function getScrollableElement() {
      const isMobile = window.matchMedia('(max-width: 763px)').matches;
      return isMobile ? document.getElementById('imageContainer') : document.querySelector('.scroller');
    }

    async function loadMetadata() {
      const res = await fetch(asset('metadata.txt'));
      const raw = await res.text();
      return raw.split('\n').map(l => l.trim()).filter(l => l.length > 0).map(line => {
        const hideToken = line.includes('|*|');
        const cleaned = line.replace('|*|', '');
        const parts = cleaned.split('|~|');
        const titleRaw = (parts[0] ?? '').trim();
        const link = (parts[1] ?? '').trim();
        const hideCaption = hideToken || titleRaw === '*';
        const title = hideCaption ? '' : titleRaw;
        return { title, link, hideCaption };
      });
    }

    async function renderMobile(items) {
      const container = document.getElementById('imageContainer');
      container.innerHTML = ''; container.style.display = 'flex';
      const frag = document.createDocumentFragment();
      for (let i = 0; i < items.length; i++) {
        const { title, link, hideCaption } = items[i];
        const box = createImageBox(i + 1, title, link, hideCaption, i < 2);
        frag.appendChild(box);
      }
      container.appendChild(frag);
      setupArrowVisibility(container);
      container.addEventListener('scroll', () => setupArrowVisibility(container), { passive: true });
    }

    async function renderDesktop(items) {
      const container = document.getElementById('imageContainer');
      container.innerHTML = '';
      const wrapper = document.createElement('div'); wrapper.className = 'desktop-wrapper';
      const scroller = document.createElement('div'); scroller.className = 'scroller';
      const topRow = document.createElement('div'); topRow.className = 'image-row';
      const bottomRow = document.createElement('div'); bottomRow.className = 'image-row';
      scroller.appendChild(topRow); scroller.appendChild(bottomRow); wrapper.appendChild(scroller); container.appendChild(wrapper);
      let topTotal = 0, bottomTotal = 0;
      for (let i = 0; i < items.length; i++) {
        const { title, link, hideCaption } = items[i];
        const box = createImageBox(i + 1, title, link, hideCaption, i < 4);
        if (topTotal <= bottomTotal) { topRow.appendChild(box); topTotal += 1; }
        else { bottomRow.appendChild(box); bottomTotal += 1; }
      }
      setupArrowVisibility(scroller);
      scroller.addEventListener('scroll', () => setupArrowVisibility(scroller), { passive: true });
    }

    async function renderBasedOnViewport() {
      if (!window.__items) window.__items = await loadMetadata();
      const isMobile = window.matchMedia('(max-width: 763px)').matches;
      if (isMobile === _lastIsMobile && document.querySelector('.image-box')) return;
      _lastIsMobile = isMobile;
      await (isMobile ? renderMobile : renderDesktop)(window.__items);
    }

    window.addEventListener('DOMContentLoaded', renderBasedOnViewport, { passive: true });
    window.addEventListener('resize', () => { clearTimeout(_resizeTimer); _resizeTimer = setTimeout(renderBasedOnViewport, 150); }, { passive: true });

    document.getElementById('arrowLeft').onclick = () => {
      const scroller = getScrollableElement();
      if (scroller) scroller.scrollBy({ left: -500, behavior: 'smooth' });
    };
    document.getElementById('arrowRight').onclick = () => {
      const scroller = getScrollableElement();
      if (scroller) scroller.scrollBy({ left: 500, behavior: 'smooth' });
    };
  </script>
</body>
</html>
